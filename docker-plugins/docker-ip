#!/usr/bin/env bash

docker_cli_plugin_metadata() {
	local vendor="lanrat"
	local description="list container IPs"
	cat <<-EOF
	{"SchemaVersion":"0.1.0","Vendor":"${vendor}","ShortDescription":"${description}"}
EOF
}

usage() {
	echo "Usage: docker ip [container_name]"
	echo ""
	echo "List Docker container IP addresses. If no container is specified, shows all containers."
	echo ""
	echo "Arguments:"
	echo "  container_name    Name of specific container to inspect (optional)"
}

docker-ip() {
	query="$1"
	if [ -z "${1}" ]; then
		query="$(docker ps -a --format '{{.Names}}')"
	fi
	{
		echo "CONTAINER|IPv4|IPv6"
		docker inspect --format '{{.Name}}|{{range $v := .NetworkSettings.Networks}}{{$v.IPAddress}}{{","}}{{end}}|{{range $v := .NetworkSettings.Networks}}{{$v.GlobalIPv6Address}}{{","}}{{end}}' $query \
		| cut -d '/' -f2 \
		| sed 's/,|/|/g; s/,$//; s/|,/|/g; s/,,*/,/g' \
		| sort
	} | sed 's/|/\t/g' | column -t
}

case "$1" in
	docker-cli-plugin-metadata)
		docker_cli_plugin_metadata
		;;
	__complete)
		docker ps -a --format '{{.Names}}' | grep -v "^$"
		;;
	*)
		# Check if second argument is help flag
		if [[ "$2" == "--help" || "$2" == "-h" ]]; then
			usage
		else
			docker-ip "$2"
		fi
		;;
esac
