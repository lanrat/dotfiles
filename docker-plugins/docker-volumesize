#!/usr/bin/env bash

docker_cli_plugin_metadata() {
	local vendor="lanrat"
	local description="show volume size for local volumes"
	cat <<-EOF
	{"SchemaVersion":"0.1.0","Vendor":"${vendor}","ShortDescription":"${description}"}
EOF
}

usage() {
	echo "Usage: docker volumesize [OPTIONS] <volume_name...>"
	echo ""
	echo "Show the size of one or more Docker volumes."
	echo ""
	echo "Options:"
	echo "  -a, --all      Show size of all volumes"
	echo ""
	echo "Arguments:"
	echo "  volume_name    Name(s) of the volume(s) to check size"
}

show-volume-size() {
    local volume="$1"
    if ! docker volume ls -q | grep -q "^$volume\$"; then
        echo "volume $volume does not exist!"
        return 1
    fi
    docker run --rm --name "volume-size-$volume" --volume "$volume:/$volume/:ro" bash du -sh /$volume
}

docker-volumesize() {
    if [ $# -lt 1 ]; then
        usage
        exit 1
    fi

    # Check for --all or -a flag
    if [[ "$1" == "--all" || "$1" == "-a" ]]; then
        local volumes
        volumes=$(docker volume ls -q | grep -v "^$")
        if [ -z "$volumes" ]; then
            echo "No volumes found."
            exit 0
        fi
        for volume in $volumes; do
            show-volume-size "$volume"
        done
        exit 0
    fi

    for volume in "$@"; do
        show-volume-size "$volume"
    done
}

case "$1" in
	docker-cli-plugin-metadata)
		docker_cli_plugin_metadata
		;;
	__complete)
		echo "-a"
		echo "--all"
		docker volume ls -q | grep -v "^$"
		;;
	*)
		# Check if second argument is help flag
		if [[ "$2" == "--help" || "$2" == "-h" ]]; then
			usage
		else
			docker-volumesize "${@:2}"
		fi
		;;
esac
