#!/usr/bin/env bash

docker_cli_plugin_metadata() {
	local vendor="lanrat"
	local description="copy volume from old_name to new_name"
	cat <<-EOF
	{"SchemaVersion":"0.1.0","Vendor":"${vendor}","ShortDescription":"${description}"}
EOF
}

usage() {
	echo "Usage: docker volumecp <existing_volume> <new_volume>"
	echo ""
	echo "Copy a Docker volume to a new volume."
	echo ""
	echo "Arguments:"
	echo "  existing_volume    Name of the source volume"
	echo "  new_volume         Name of the destination volume (must not exist)"
}

docker-volumecp() {
    if [ ! $# -eq 2 ]
    then
        usage
        exit 1
    fi

    if ! docker volume ls -q | grep -q "^$1\$"; then
        echo "volume $1 does not exist!"
        exit 1
    fi

    if docker volume ls -q | grep -q "^$2\$"; then
        echo "volume $2 already exists!"
        exit 1
    fi

    echo "Copying $1 -> $2"
    docker run --rm -it -v "$1:/old/:ro" -v "$2:/new" bash cp -drp /old/. /new
}

case "$1" in
	docker-cli-plugin-metadata)
		docker_cli_plugin_metadata
		;;
	__complete)
		docker volume ls -q | grep -v "^$"
		;;
	*)
		# Check if second argument is help flag
		if [[ "$2" == "--help" || "$2" == "-h" ]]; then
			usage
		else
			docker-volumecp "${@:2}"
		fi
		;;
esac
